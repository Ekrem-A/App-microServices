# ============================================================
# E-Commerce Microservices Platform - Full Docker Compose
# ============================================================
#
# Architecture:
#   [Gateway.Api] ─┐
#   [Catalog.Api]  ─┤
#   [Identity.Api] ─┤── OTLP (gRPC) ──▶ [OTEL Collector]
#   [Order.Api]    ─┤                         │
#   [Payment.Api]  ─┤                    Elastic APM
#   [Cart.Api]     ─┘                         │
#                                        [APM Server]
#                                             │
#                                      [Elasticsearch] ──▶ [Kibana]
#
# Ports:
#   Gateway   : 5000
#   Catalog   : 5001
#   Identity  : 5002
#   Order     : 5003
#   Payment   : 5004
#   Cart      : 5005
#   Kibana    : 5601
#   ES        : 9200
#   APM       : 8200
#   OTEL gRPC : 4317
#   OTEL HTTP : 4318
# ============================================================

services:

  # ==========================================
  # OBSERVABILITY STACK
  # ==========================================

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.18
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - platform
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.18
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - platform
    restart: unless-stopped

  apm-server:
    image: docker.elastic.co/apm/apm-server:7.17.18
    container_name: apm-server
    command: >
      apm-server -e
        -E apm-server.host=0.0.0.0:8200
        -E apm-server.rum.enabled=true
        -E output.elasticsearch.hosts=["http://elasticsearch:9200"]
        -E apm-server.auth.anonymous.enabled=true
        -E apm-server.kibana.enabled=true
        -E apm-server.kibana.host=http://kibana:5601
    ports:
      - "8200:8200"
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - platform
    healthcheck:
      test: ["CMD", "apm-server", "export", "config"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    container_name: otel-collector
    command: ["--config=/etc/otel-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-config.yaml
    ports:
      - "4317:4317"
      - "4318:4318"
      - "8889:8889"  # Prometheus exporter
      - "13133:13133"  # Health check
    depends_on:
      apm-server:
        condition: service_healthy
    networks:
      - platform
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.49.1
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      - otel-collector
    networks:
      - platform
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.3.1
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - platform
    restart: unless-stopped

  # ==========================================
  # DATABASES
  # ==========================================

  catalog-sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: catalog-sqlserver
    environment:
      SA_PASSWORD: "YourStrong@Passw0rd"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Express"
    ports:
      - "1434:1433"
    volumes:
      - catalog_sqlserver_data:/var/opt/mssql
    networks:
      - platform
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  identity-sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: identity-sqlserver
    environment:
      SA_PASSWORD: "YourStrong@Passw0rd"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Express"
    ports:
      - "1435:1433"
    volumes:
      - identity_sqlserver_data:/var/opt/mssql
    networks:
      - platform
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  order-sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: order-sqlserver
    environment:
      SA_PASSWORD: "YourStrong@Passw0rd"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Express"
    ports:
      - "1436:1433"
    volumes:
      - order_sqlserver_data:/var/opt/mssql
    networks:
      - platform
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  payment-sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: payment-sqlserver
    environment:
      SA_PASSWORD: "YourStrong@Passw0rd"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Express"
    ports:
      - "1437:1433"
    volumes:
      - payment_sqlserver_data:/var/opt/mssql
    networks:
      - platform
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  catalog-redis:
    image: redis:7-alpine
    container_name: catalog-redis
    ports:
      - "6380:6379"
    volumes:
      - catalog_redis_data:/data
    networks:
      - platform
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes
    restart: unless-stopped

  cart-redis:
    image: redis:7-alpine
    container_name: cart-redis
    ports:
      - "6381:6379"
    volumes:
      - cart_redis_data:/data
    networks:
      - platform
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes
    restart: unless-stopped

  # ==========================================
  # MESSAGE BROKER (KAFKA)
  # ==========================================

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - platform
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - platform
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8082:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: platform
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - platform
    restart: unless-stopped

  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      echo 'Creating Kafka topics...'
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic order-created --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic order-cancelled --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic payment-succeeded --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic payment-failed --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic refund-completed --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic refund-failed --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic cart.checkout.v1 --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic catalog.product.created --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic catalog.product.updated --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic catalog.product.stock-updated --partitions 3 --replication-factor 1
      echo 'Topics created successfully!'
      kafka-topics --bootstrap-server kafka:29092 --list
      "
    networks:
      - platform

  # ==========================================
  # API GATEWAY
  # ==========================================

  gateway-api:
    build:
      context: ./Gateway.Api
      dockerfile: Gateway.Api/Dockerfile
    container_name: gateway-api
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=Gateway.Api
      - ReverseProxy__Clusters__catalog__Destinations__default__Address=http://catalog-api:8080
      - ReverseProxy__Clusters__identity__Destinations__default__Address=http://identity-api:8080
      - ReverseProxy__Clusters__order__Destinations__default__Address=http://order-api:8080
      - ReverseProxy__Clusters__payment__Destinations__default__Address=http://payment-api:8080
      - ReverseProxy__Clusters__cart__Destinations__default__Address=http://cart-api:8080
    depends_on:
      otel-collector:
        condition: service_started
    networks:
      - platform
    restart: unless-stopped

  # ==========================================
  # MICROSERVICES
  # ==========================================

  catalog-api:
    build:
      context: ./Catalog.Api
      dockerfile: Catalog.Api/Dockerfile
    container_name: catalog-api
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=catalog-sqlserver,1433;Database=catalogdb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - Redis__Configuration=catalog-redis:6379
      - Redis__InstanceName=CatalogCache_
      - Redis__Enabled=true
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - ApiKeySettings__Enabled=false
      - RateLimitSettings__Enabled=false
      - Kafka__BootstrapServers=kafka:29092
    depends_on:
      catalog-sqlserver:
        condition: service_healthy
      catalog-redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      - platform
    restart: unless-stopped

  identity-api:
    build:
      context: ./Idendity.Api
      dockerfile: Idendity.Api/Dockerfile
    container_name: identity-api
    ports:
      - "5002:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=identity-sqlserver,1433;Database=IdendityDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - RUN_MIGRATIONS=true
    depends_on:
      identity-sqlserver:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      - platform
    restart: unless-stopped

  order-api:
    build:
      context: ./Order.Api
      dockerfile: Dockerfile
    container_name: order-api
    ports:
      - "5003:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__OrderDb=Server=order-sqlserver,1433;Database=OrderDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - Database__AutoMigrate=true
      - Authentication__SecretKey=SuperSecretKeyForDevelopment12345678
      - Authentication__Audience=order-api
      - EnableSwagger=true
      - Kafka__BootstrapServers=kafka:29092
      - Kafka__GroupId=order-service
    depends_on:
      order-sqlserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      - platform
    restart: unless-stopped

  payment-api:
    build:
      context: ./Payment.Api
      dockerfile: Dockerfile
    container_name: payment-api
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=payment-sqlserver,1433;Database=PaymentDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - Kafka__BootstrapServers=kafka:29092
      - Kafka__GroupId=payment-service
    depends_on:
      payment-sqlserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      - platform
    restart: unless-stopped

  cart-api:
    build:
      context: ./Cart.Api
      dockerfile: Cart.Api/Dockerfile
    container_name: cart-api
    ports:
      - "5005:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Redis__ConnectionString=cart-redis:6379
      - OpenTelemetry__Endpoint=http://otel-collector:4317
      - Kafka__BootstrapServers=kafka:29092
    depends_on:
      cart-redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      - platform
    restart: unless-stopped

# ==========================================
# NETWORKS & VOLUMES
# ==========================================

networks:
  platform:
    driver: bridge

volumes:
  es_data:
  prometheus_data:
  grafana_data:
  catalog_sqlserver_data:
  identity_sqlserver_data:
  order_sqlserver_data:
  payment_sqlserver_data:
  catalog_redis_data:
  cart_redis_data:
  kafka_data:
  zookeeper_data:
